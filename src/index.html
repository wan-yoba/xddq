<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Login</title>
    <style>
      /* åŸºç¡€æ ·å¼é‡ç½® */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #3498db);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 1rem;
        padding: 2rem;
        width: 100%;
        max-width: 600px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: #2c3e50;
        font-size: 2.2rem;
        letter-spacing: -0.5px;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #34495e;
        font-weight: 600;
        font-size: 0.9rem;
      }

      input,
      select {
        width: 100%;
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 0.8rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      input:focus,
      select:focus {
        border-color: #3498db;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      input[readonly] {
        background-color: #f1f3f5;
      }

      button {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 0.8rem;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        cursor: button;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
      }

      button:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      button:active:not([disabled]) {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .log-container {
        margin-top: 2rem;
        background: #f8f9fa;
        border-radius: 0.8rem;
        padding: 0.3rem;
        height: 400px;
        display: flex;
        flex-direction: column;
        display: none;
        /* é»˜è®¤éšè—æ—¥å¿—ç»„ä»¶ */
      }

      .log-header {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
      }

      #logOutput {
        flex: 1;
        overflow-y: auto;
        background: white;
        border-radius: 0.6rem;
        padding: 0.5rem;
        border: 2px solid #e9ecef;
      }

      .log {
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.4rem;
        font-size: 0.9rem;
        color: #34495e;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
      }

      .spinner {
        width: 3rem;
        height: 3rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      #toast-container {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .toast {
        padding: 1rem 1.5rem;
        border-radius: 0.8rem;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        opacity: 1;
        transition: all 0.3s ease;
      }

      .toast.fade-out {
        opacity: 0;
        transform: translateY(20%);
      }

      /* ç”¨æˆ·ä¿¡æ¯å¸ƒå±€ */
      .user-info {
        display: none;
        /* é»˜è®¤éšè— */
        text-align: left;
        margin-bottom: 2rem;
      }

      .user-details {
        display: flex;
        align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
      }

      .user-info img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 1rem; /* å¤´åƒä¸å³ä¾§æ–‡å­—çš„é—´è· */

        /* ç¾åŒ–å¤´åƒ */
        border: 4px solid #fff; /* æ·»åŠ ç™½è‰²è¾¹æ¡† */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* æ·»åŠ é˜´å½±æ•ˆæœ */
        transition: all 0.3s ease; /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
      }

      /* å¤´åƒæ‚¬åœæ•ˆæœ */
      .user-info img:hover {
        transform: scale(1.1); /* æ‚¬åœæ—¶æ”¾å¤§å¤´åƒ */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* å¢å¼ºé˜´å½± */
      }

      .user-info-text {
        display: flex;
        flex-direction: column;
      }

      .user-info h2 {
        color: #2c3e50;
        font-size: 1.5rem;
        margin: 0;
      }

      .user-info p {
        color: #7f8c8d;
        font-size: 1rem;
        margin: 0.5rem 0 0 0; /* è°ƒæ•´æ–‡æœ¬ä¹‹é—´çš„é—´è· */
      }

      /* æ·»åŠ è¿æ¥çŠ¶æ€æ ·å¼ */
      .connection-status {
        background: rgba(255, 255, 255, 0.9);
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: none;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ccc;
      }

      .status-text {
        color: #666;
        font-weight: 500;
      }

      #connectionState {
        color: #444;
        font-weight: 600;
      }

      .reconnect-btn {
        margin-left: auto;
        padding: 6px 12px;
        background: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: none;
      }
      .status-indicator {
        transition: background-color 0.3s ease;
      }

      .reconnect-btn {
        transition: opacity 0.3s ease;
      }
      /* çŠ¶æ€é¢œè‰² */
      [data-status="connected"] .status-indicator {
        background: #2ecc71;
      }
      [data-status="connecting"] .status-indicator {
        background: #f1c40f;
      }
      [data-status="reconnecting"] .status-indicator {
        background: #e67e22;
      }
      [data-status="disconnected"] .status-indicator {
        background: #e74c3c;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- åœ¨containerå†…çš„é¡¶éƒ¨æ·»åŠ è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <div class="connection-status">
        <div class="status-indicator"></div>
        <span class="status-text">WebSocket: </span>
        <span id="connectionState">æœªè¿æ¥</span>
        <button id="manualReconnect" class="reconnect-btn">â†» é‡è¿</button>
      </div>

      <div id="overlay" class="overlay" style="display: none">
        <div class="spinner"></div>
      </div>

      <!-- ç™»å½•è¡¨å• -->
      <div id="loginForm">
        <h1>ğŸ® Game Login</h1>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" placeholder="Enter username" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Enter password" />
        </div>
        <button id="fetchServersBtn" onclick="fetchServerList()">
          ğŸŒ Get Server List
        </button>

        <div class="form-group">
          <label>Select Server</label>
          <select id="servers" onchange="updateServerId()" disabled>
            <option value="">-- Choose Server --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Server ID</label>
          <input
            type="text"
            id="serverId"
            readonly
            placeholder="Selected Server ID"
          />
        </div>
        <button id="loginBtn" onclick="login()">ğŸš€ Start Gaming</button>
      </div>

      <!-- ç”¨æˆ·ä¿¡æ¯å¸ƒå±€ -->
      <div id="userInfo" class="user-info">
        <div class="user-details">
          <img src="https://thirdwx.qlogo.cn/mmopen/" alt="User Avatar" />
          <div class="user-info-text">
            <h2 id="userName">John Doe</h2>
            <p id="playerBelong">New York, USA</p>
            <p id="playerId">User ID: 123456</p>
          </div>
        </div>
      </div>

      <!-- æ—¥å¿—ç»„ä»¶ -->
      <div class="log-container">
        <div class="log-header">Game Logs</div>
        <div id="logOutput"></div>
      </div>
    </div>

    <div id="toast-container"></div>

    <script>
      const MAX_LOG_ITEMS = 50;
      let logCount = 0;
      let ws = null;
      let baseUrl = "localhost:8012";
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5; // æœ€å¤§é‡è¿æ¬¡æ•°
      const reconnectInterval = 3000 * 10; // é‡è¿é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = ` <span>${message}</span> `;
        const container = document.getElementById("toast-container");
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function updateServerId() {
        document.getElementById("serverId").value =
          document.getElementById("servers").value;
      }

      function showOverlay() {
        document.getElementById("overlay").style.display = "flex";
      }

      function hideOverlay() {
        document.getElementById("overlay").style.display = "none";
      }

      async function fetchServerList() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password) {
          showToast("ğŸ” Please enter username and password", "warning");
          return;
        }
        try {
          showOverlay();
          const response = await fetch(
            `http://${baseUrl}/api/servers?username=${encodeURIComponent(
              username
            )}&password=${encodeURIComponent(password)}`
          );
          const data = await response.json();
          const select = document.getElementById("servers");
          select.innerHTML = '<option value="">-- Choose Server --</option>';
          if (data.servers?.length) {
            data.servers.forEach((server) => {
              const option = new Option(server.serverName, server.serverId);
              select.add(option);
            });
            select.disabled = false;
            showToast("ğŸŒ Server list updated", "success");
          } else {
            showToast("âš ï¸ No servers available", "error");
          }
        } catch (error) {
          showToast(`âŒ Error: ${error.message}`, "error");
        } finally {
          hideOverlay();
        }
      }

      async function login() {
        if (baseUrl == "" || baseUrl == null) {
          showToast("ğŸš¨ Please config base request url !", "error");
          return;
        }
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const serverId = document.getElementById("serverId").value.trim();
        if (!username || !password || !serverId) {
          showToast("ğŸš¨ Please complete all fields", "error");
          return;
        }
        try {
          showOverlay();
          const response = await fetch(`http://${baseUrl}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, serverId }),
          });
          const data = await response.json();
          if (data.playerId && data.token) {
            // éšè—ç™»å½•è¡¨å•
            document.getElementById("loginForm").style.display = "none";
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯ã€æ—¥å¿—ç»„ä»¶ä»¥åŠé“¾æ¥çŠ¶æ€
            document.getElementById("userInfo").style.display = "block";
            document.querySelector(".log-container").style.display = "flex";
            document.querySelector(".connection-status").style.display = "flex";
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById("userName").textContent = username;
            // ç¦ç”¨è¡¨å•
            disableForm(true);
            // è¿æ¥ WebSocket
            connectWebSocket(`ws://${baseUrl}/ws?userId=${data.playerId}`);
            showToast("ğŸ‰ Login successful!", "success");
          } else {
            showToast("âš ï¸ Invalid credentials", "error");
          }
        } catch (error) {
          showToast(`âŒ Connection error: ${error.message}`, "error");
        } finally {
          hideOverlay();
        }
      }

      function getCurrentDetailedTime() {
        // åˆ›å»º Date å¯¹è±¡
        const now = new Date();

        // è·å–å¹´ã€æœˆã€æ—¥
        const year = now.getFullYear(); // å¹´ä»½ï¼ˆå››ä½æ•°ï¼‰
        const month = String(now.getMonth() + 1).padStart(2, "0"); // æœˆä»½ï¼ˆ0-11ï¼Œéœ€è¦ +1ï¼‰
        const day = String(now.getDate()).padStart(2, "0"); // æ—¥æœŸï¼ˆ1-31ï¼‰

        // è·å–æ—¶ã€åˆ†ã€ç§’ã€æ¯«ç§’
        const hours = String(now.getHours()).padStart(2, "0"); // å°æ—¶ï¼ˆ0-23ï¼‰
        const minutes = String(now.getMinutes()).padStart(2, "0"); // åˆ†é’Ÿï¼ˆ0-59ï¼‰
        const seconds = String(now.getSeconds()).padStart(2, "0"); // ç§’ï¼ˆ0-59ï¼‰
        const milliseconds = String(now.getMilliseconds()).padStart(3, "0"); // æ¯«ç§’ï¼ˆ0-999ï¼‰

        // æ ¼å¼åŒ–æ—¶é—´
        const formattedTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;

        return formattedTime;
      }

      function disableForm(disabled) {
        const elements = [
          "username",
          "password",
          "servers",
          "loginBtn",
          "fetchServersBtn",
        ];
        elements.forEach((id) => {
          document.getElementById(id).disabled = disabled;
        });
      }

      // ä¼˜åŒ–åçš„é‡è¿
      class WSConnection {
        constructor() {
          this.ws = null;
          this.reconnectAttempts = 0;
          this.maxReconnectAttempts = 5;
          this.baseReconnectInterval = 3000;
          this.currentInterval = 3000;
          this.url = "";
          this.retryTimer = null;
        }

        connect(url) {
          this.url = url;
          this.cleanup();
          this.updateStatus("connecting");

          this.ws = new WebSocket(url);
          this.bindEvents();
        }

        bindEvents() {
          this.ws.onopen = () => {
            this.handleOpen();
            this.scheduleHeartbeat();
          };

          this.ws.onmessage = (e) => this.handleMessage(e);
          this.ws.onclose = (e) => this.handleClose(e);
          this.ws.onerror = (e) => this.handleError(e);
        }

        handleOpen() {
          this.reconnectAttempts = 0;
          this.currentInterval = this.baseReconnectInterval;
          this.updateStatus("connected");
          showToast("webSocket connect successful .", "success");
        }

        handleMessage(event) {
          try {
            const data = JSON.parse(event.data);
            this.appendLog(data.level, data.message, data.timestamp);

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            if (data.message?.indexOf("wxHeadUrl") != -1) {
              this.updateUserInfo(JSON.parse(data.message));
            }
          } catch (error) {
            this.appendLog("error", `æ¶ˆæ¯è§£æå¤±è´¥: ${error.message}`);
          }
        }

        handleClose(event) {
          const reason = event.reason || "webSocket disconnected .";
          this.appendLog("error", `è¿æ¥å…³é—­: ${reason}`);
          this.updateStatus("reconnecting");
          this.scheduleReconnect();
        }

        handleError(error) {
          this.appendLog("error", `è¿æ¥é”™è¯¯: ${error.message}`);
          this.ws.close();
        }

        scheduleReconnect() {
          if (this.reconnectAttempts < this.maxReconnectAttempts) {
            this.reconnectAttempts++;
            this.currentInterval *= 2; // æŒ‡æ•°é€€é¿

            this.retryTimer = setTimeout(() => {
              this.appendLog(
                "info",
                `å°è¯•ç¬¬${this.reconnectAttempts}æ¬¡é‡è¿...`
              );
              this.connect(this.url);
            }, this.currentInterval);

            this.updateUIState();
          } else {
            this.updateStatus("disconnected");
            showToast("è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°", "error");
          }
        }

        manualReconnect() {
          clearTimeout(this.retryTimer);
          this.reconnectAttempts = 0;
          this.connect(this.url);
        }

        updateStatus(state) {
          const statusMap = {
            connected: "å·²è¿æ¥",
            connecting: "è¿æ¥ä¸­...",
            reconnecting: `é‡è¿ä¸­ (${this.reconnectAttempts}/${this.maxReconnectAttempts})`,
            disconnected: "å·²æ–­å¼€",
          };

          const indicator = document.querySelector(".status-indicator");
          const stateElement = document.getElementById("connectionState");
          const reconnectBtn = document.getElementById("manualReconnect");

          // æ›´æ–°çŠ¶æ€å±æ€§
          document.querySelector(".connection-status").dataset.status = state;

          // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
          stateElement.textContent = statusMap[state];

          // æ§åˆ¶é‡è¿æŒ‰é’®
          reconnectBtn.style.display = [
            "reconnecting",
            "disconnected",
          ].includes(state)
            ? "block"
            : "none";
        }

        updateUserInfo(userInfo) {
          console.log("updateUserInfo ~");
          console.dir(userInfo);
          const updateElement = (selector, value) => {
            const el = document.querySelector(selector);
            if (el) el.textContent = value;
          };

          const img = document.querySelector("#userInfo img");
          if (img) img.src = userInfo.wxHeadUrl;

          updateElement("#userName", userInfo.nickName);
          updateElement("#playerBelong", userInfo.playerBelong);
          updateElement("#playerId", userInfo.playerId);
        }

        scheduleHeartbeat() {
          this.heartbeatInterval = setInterval(() => {
            if (this.ws?.readyState === WebSocket.OPEN) {
              this.ws.send(JSON.stringify({ type: "heartbeat" }));
            }
          }, 30000);
        }

        cleanup() {
          clearInterval(this.heartbeatInterval);
          if (this.ws) {
            this.ws.removeAllListeners();
            this.ws.close();
          }
        }

        appendLog(level, message, timestamp = getCurrentDetailedTime()) {
          const logOutput = document.getElementById("logOutput");
          const logItem = document.createElement("div");
          logItem.className = "log";

          // é¢œè‰²é…ç½®å¯¹è±¡
          const colorMap = {
            info: "#3498db",
            warning: "#f39c12",
            error: "#e74c3c",
            default: "#34495e",
          };

          // è·å–å¯¹åº”é¢œè‰²
          const logLevel = level.toLowerCase();
          const color = colorMap[logLevel] || colorMap.default;

          logItem.innerHTML = `
    <span style="color: ${color}; font-weight: 600;">[${logLevel.toUpperCase()}]</span>
    <span style="color: #95a5a6;">[${timestamp}]</span> 
    - ${message}
  `;

          // ä½¿ç”¨ prepend ä»£æ›¿ insertBefore æ›´ç®€æ´
          logOutput.prepend(logItem);

          // ä¼˜åŒ–æ—¥å¿—æ•°é‡æ§åˆ¶
          if (logOutput.children.length > MAX_LOG_ITEMS) {
            logOutput.lastElementChild?.remove();
          }
        }
      }

      // åˆå§‹åŒ–WebSocketç®¡ç†å®ä¾‹
      const wsManager = new WSConnection();

      // åœ¨ç™»å½•æˆåŠŸåè°ƒç”¨
      function connectWebSocket(url) {
        console.log(" webSocket ", url);
        wsManager.connect(url);
      }

      // ç»‘å®šæ‰‹åŠ¨é‡è¿æŒ‰é’®
      document
        .getElementById("manualReconnect")
        .addEventListener("click", () => {
          wsManager.manualReconnect();
        });

      // æ·»åŠ é¡µé¢å¯è§æ€§ç›‘å¬
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible" && !wsManager.ws) {
          wsManager.manualReconnect();
        }
      });
    </script>
  </body>
</html>
