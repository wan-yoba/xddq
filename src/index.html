<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game Login</title>
    <style>
      /* åŸºç¡€æ ·å¼é‡ç½® */
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #2c3e50, #3498db);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 1rem;
        padding: 2rem;
        width: 100%;
        max-width: 600px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        margin-bottom: 2rem;
        color: #2c3e50;
        font-size: 2.2rem;
        letter-spacing: -0.5px;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        color: #34495e;
        font-weight: 600;
        font-size: 0.9rem;
      }

      input,
      select {
        width: 100%;
        padding: 0.8rem 1.2rem;
        font-size: 1rem;
        border: 2px solid #e0e0e0;
        border-radius: 0.8rem;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }

      input:focus,
      select:focus {
        border-color: #3498db;
        background: #fff;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
      }

      input[readonly] {
        background-color: #f1f3f5;
      }

      button {
        width: 100%;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 0.8rem;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        cursor: button;
        transition: all 0.3s ease;
        margin-top: 0.5rem;
      }

      button:hover:not([disabled]) {
        transform: translateY(-1px);
        box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
      }

      button:active:not([disabled]) {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .log-container {
        margin-top: 2rem;
        background: #f8f9fa;
        border-radius: 0.8rem;
        padding: 0.3rem;
        height: 400px;
        display: flex;
        flex-direction: column;
        display: none;
        /* é»˜è®¤éšè—æ—¥å¿—ç»„ä»¶ */
      }

      .log-header {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
      }

      #logOutput {
        flex: 1;
        overflow-y: auto;
        background: white;
        border-radius: 0.6rem;
        padding: 0.5rem;
        border: 2px solid #e9ecef;
      }

      .log {
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.4rem;
        font-size: 0.9rem;
        color: #34495e;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(3px);
      }

      .spinner {
        width: 3rem;
        height: 3rem;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      #toast-container {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .toast {
        padding: 1rem 1.5rem;
        border-radius: 0.8rem;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        opacity: 1;
        transition: all 0.3s ease;
      }

      .toast.fade-out {
        opacity: 0;
        transform: translateY(20%);
      }

      /* ç”¨æˆ·ä¿¡æ¯å¸ƒå±€ */
      .user-info {
        display: none;
        /* é»˜è®¤éšè— */
        text-align: left;
        margin-bottom: 2rem;
      }

      .user-details {
        display: flex;
        align-items: center; /* å‚ç›´å±…ä¸­å¯¹é½ */
      }

      .user-info img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 1rem; /* å¤´åƒä¸å³ä¾§æ–‡å­—çš„é—´è· */

        /* ç¾åŒ–å¤´åƒ */
        border: 4px solid #fff; /* æ·»åŠ ç™½è‰²è¾¹æ¡† */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* æ·»åŠ é˜´å½±æ•ˆæœ */
        transition: all 0.3s ease; /* å¹³æ»‘è¿‡æ¸¡æ•ˆæœ */
      }

      /* å¤´åƒæ‚¬åœæ•ˆæœ */
      .user-info img:hover {
        transform: scale(1.1); /* æ‚¬åœæ—¶æ”¾å¤§å¤´åƒ */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2); /* å¢å¼ºé˜´å½± */
      }

      .user-info-text {
        display: flex;
        flex-direction: column;
      }

      .user-info h2 {
        color: #2c3e50;
        font-size: 1.5rem;
        margin: 0;
      }

      .user-info p {
        color: #7f8c8d;
        font-size: 1rem;
        margin: 0.5rem 0 0 0; /* è°ƒæ•´æ–‡æœ¬ä¹‹é—´çš„é—´è· */
      }
    </style>
  </head>

  <body>
    <div class="container">
      <div id="overlay" class="overlay" style="display: none">
        <div class="spinner"></div>
      </div>

      <!-- ç™»å½•è¡¨å• -->
      <div id="loginForm">
        <h1>ğŸ® Game Login</h1>
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" placeholder="Enter username" />
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" placeholder="Enter password" />
        </div>
        <button id="fetchServersBtn" onclick="fetchServerList()">
          ğŸŒ Get Server List
        </button>

        <div class="form-group">
          <label>Select Server</label>
          <select id="servers" onchange="updateServerId()" disabled>
            <option value="">-- Choose Server --</option>
          </select>
        </div>
        <div class="form-group">
          <label>Server ID</label>
          <input
            type="text"
            id="serverId"
            readonly
            placeholder="Selected Server ID"
          />
        </div>
        <button id="loginBtn" onclick="login()">ğŸš€ Start Gaming</button>
      </div>

      <!-- ç”¨æˆ·ä¿¡æ¯å¸ƒå±€ -->
      <div id="userInfo" class="user-info">
        <div class="user-details">
          <img src="https://thirdwx.qlogo.cn/mmopen/" alt="User Avatar" />
          <div class="user-info-text">
            <h2 id="userName">John Doe</h2>
            <p id="playerBelong">New York, USA</p>
            <p id="playerId">User ID: 123456</p>
          </div>
        </div>
      </div>

      <!-- æ—¥å¿—ç»„ä»¶ -->
      <div class="log-container">
        <div class="log-header">Game Logs</div>
        <div id="logOutput"></div>
      </div>
    </div>
    <div id="toast-container"></div>
    <script>
      const MAX_LOG_ITEMS = 50;
      let logCount = 0;
      let ws = null;
      let baseUrl = "";
      let reconnectAttempts = 0;
      const maxReconnectAttempts = 5; // æœ€å¤§é‡è¿æ¬¡æ•°
      const reconnectInterval = 3000 * 10; // é‡è¿é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰

      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `toast ${type}`;
        toast.innerHTML = ` <span>${message}</span> `;
        const container = document.getElementById("toast-container");
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add("fade-out");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      function updateServerId() {
        document.getElementById("serverId").value =
          document.getElementById("servers").value;
      }

      function showOverlay() {
        document.getElementById("overlay").style.display = "flex";
      }

      function hideOverlay() {
        document.getElementById("overlay").style.display = "none";
      }

      async function fetchServerList() {
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!username || !password) {
          showToast("ğŸ” Please enter username and password", "warning");
          return;
        }
        try {
          showOverlay();
          const response = await fetch(
            `http://${baseUrl}/api/servers?username=${encodeURIComponent(
              username
            )}&password=${encodeURIComponent(password)}`
          );
          const data = await response.json();
          const select = document.getElementById("servers");
          select.innerHTML = '<option value="">-- Choose Server --</option>';
          if (data.servers?.length) {
            data.servers.forEach((server) => {
              const option = new Option(server.serverName, server.serverId);
              select.add(option);
            });
            select.disabled = false;
            showToast("ğŸŒ Server list updated", "success");
          } else {
            showToast("âš ï¸ No servers available", "error");
          }
        } catch (error) {
          showToast(`âŒ Error: ${error.message}`, "error");
        } finally {
          hideOverlay();
        }
      }

      async function login() {
        if (baseUrl == "" || baseUrl == null) {
          showToast("ğŸš¨ Please config base request url !", "error");
          return;
        }
        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value.trim();
        const serverId = document.getElementById("serverId").value.trim();
        if (!username || !password || !serverId) {
          showToast("ğŸš¨ Please complete all fields", "error");
          return;
        }
        try {
          showOverlay();
          const response = await fetch(`http://${baseUrl}/api/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password, serverId }),
          });
          const data = await response.json();
          if (data.playerId && data.token) {
            // éšè—ç™»å½•è¡¨å•
            document.getElementById("loginForm").style.display = "none";
            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯å’Œæ—¥å¿—ç»„ä»¶
            document.getElementById("userInfo").style.display = "block";
            document.querySelector(".log-container").style.display = "flex";
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById("userName").textContent = username;
            // ç¦ç”¨è¡¨å•
            disableForm(true);
            // è¿æ¥ WebSocket
            connectWebSocket(`ws://${baseUrl}/ws?userId=${data.playerId}`);
            showToast("ğŸ‰ Login successful!", "success");
          } else {
            showToast("âš ï¸ Invalid credentials", "error");
          }
        } catch (error) {
          showToast(`âŒ Connection error: ${error.message}`, "error");
        } finally {
          hideOverlay();
        }
      }

      function connectWebSocket(url) {
        if (ws) ws.close();
        ws = new WebSocket(url);
        ws.onopen = () => {
          appendLog(
            "info",
            getCurrentDetailedTime(),
            "Connected to game server"
          );
          reconnectAttempts = 0; // è¿æ¥æˆåŠŸåé‡ç½®é‡è¿æ¬¡æ•°
        };
        ws.onmessage = (event) => {
          let message = JSON.parse(event.data);
          console.dir(event.data);
          appendLog(message.level, message.timestamp, message.message);

          // å¤´åƒè®¾ç½®
          if (message.message.indexOf("wxHeadUrl") != -1) {
            let userInfo = JSON.parse(message.message);
            if (userInfo) {
              // æ›´æ–°å¤´åƒå’Œåç§°
              document.querySelector("#userInfo img").src = userInfo.wxHeadUrl;
              document.querySelector("#userName").textContent =
                userInfo.nickName;
              document.querySelector("#playerBelong").textContent =
                userInfo.playerBelong;
              document.querySelector("#playerId").textContent =
                userInfo.playerId;
            }
          }
        };
        ws.onclose = () => {
          appendLog(
            "error",
            getCurrentDetailedTime(),
            "Connection closed. Game exit !"
          );
          showToast("Connection closed. Game exit !", "warn");

          // å¦‚æœæœªè¶…è¿‡æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œå°è¯•é‡è¿
          if (reconnectAttempts < maxReconnectAttempts) {
            setTimeout(() => {
              reconnectAttempts++;
              appendLog(
                "info",
                getCurrentDetailedTime(),
                `æ­£åœ¨è¿›è¡Œç¬¬ ${reconnectAttempts} æ¬¡é‡è¿...`
              );
              console.log(`é‡è¿é“¾æ¥ ${url} ï¼`)
              connectWebSocket(url); // é‡æ–°è¿æ¥
            }, reconnectInterval);
          } else {
            appendLog(
              "error",
              getCurrentDetailedTime(),
              "å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ã€‚"
            );
            showToast("å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ã€‚", "error");
          }
        };
        ws.onerror = (error) =>
          appendLog("error", getCurrentDetailedTime(), ` ${error.message}`);
      }

      function getCurrentDetailedTime() {
        // åˆ›å»º Date å¯¹è±¡
        const now = new Date();

        // è·å–å¹´ã€æœˆã€æ—¥
        const year = now.getFullYear(); // å¹´ä»½ï¼ˆå››ä½æ•°ï¼‰
        const month = String(now.getMonth() + 1).padStart(2, "0"); // æœˆä»½ï¼ˆ0-11ï¼Œéœ€è¦ +1ï¼‰
        const day = String(now.getDate()).padStart(2, "0"); // æ—¥æœŸï¼ˆ1-31ï¼‰

        // è·å–æ—¶ã€åˆ†ã€ç§’ã€æ¯«ç§’
        const hours = String(now.getHours()).padStart(2, "0"); // å°æ—¶ï¼ˆ0-23ï¼‰
        const minutes = String(now.getMinutes()).padStart(2, "0"); // åˆ†é’Ÿï¼ˆ0-59ï¼‰
        const seconds = String(now.getSeconds()).padStart(2, "0"); // ç§’ï¼ˆ0-59ï¼‰
        const milliseconds = String(now.getMilliseconds()).padStart(3, "0"); // æ¯«ç§’ï¼ˆ0-999ï¼‰

        // æ ¼å¼åŒ–æ—¶é—´
        const formattedTime = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;

        return formattedTime;
      }

      function appendLog(level, timestamp, message) {
        const logOutput = document.getElementById("logOutput");
        const logItem = document.createElement("div");
        logItem.className = "log";

        // æ ¹æ®æ—¥å¿—ç­‰çº§è®¾ç½®é¢œè‰²
        let color;
        switch (level.toLowerCase()) {
          case "info":
            color = "#3498db"; // è“è‰²
            break;
          case "warning":
            color = "#f39c12"; // æ©™è‰²
            break;
          case "error":
            color = "#e74c3c"; // çº¢è‰²
            break;
          default:
            color = "#34495e"; // é»˜è®¤ç°è‰²
        }

        // ç”Ÿæˆæ—¥å¿—å†…å®¹
        logItem.innerHTML = `
    <span style="color: ${color}; font-weight: 600;">[${level.toUpperCase()}]</span>
    <span style="color: #95a5a6;">[${timestamp}]</span> 
    - ${message}
  `;

        // ä¿æŒæ—¥å¿—å€’åºæ’åˆ—ï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
        if (logOutput.firstChild) {
          logOutput.insertBefore(logItem, logOutput.firstChild);
        } else {
          logOutput.appendChild(logItem);
        }

        // é™åˆ¶æ—¥å¿—æ•°é‡
        if (++logCount > MAX_LOG_ITEMS) {
          logOutput.removeChild(logOutput.lastChild);
        }
      }

      function disableForm(disabled) {
        const elements = [
          "username",
          "password",
          "servers",
          "loginBtn",
          "fetchServersBtn",
        ];
        elements.forEach((id) => {
          document.getElementById(id).disabled = disabled;
        });
      }
    </script>
  </body>
</html>
